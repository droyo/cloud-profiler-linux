This is an unofficial agent for the Cloud Profiler[1] that makes
tunable perf_events[2] profiles available in the Google Cloud console.
It is a wrapper for the `perf record` command that converts its output
to the format expected by the cloud profiler and uploads it using the
credentials provided via command line or in the GCE metadata server.

By default, the `cloud-profiler-perf-record` command runs once, and
uploads a single profile (this is called "offline" mode). The
--run-forever flag will cause the command to run forever, and collect
profiles at the cadence established by the Cloud Profiler service.

Once they are uploaded, the profiles can be viewed as call graphs
or flame graphs or any other visualization supported by the product.

BUILD

bazel build :sd_perf_agent

A container image target for use in containerized environments is provided
as well.

INSTALL

The build steps create a statically linked binary that can be copied
into your location of choice for running binaries. The scripts/ directory
contains supporting files to run this program in various ways:

* A systemd unit file is provided to run under Linux distributions using systemd
* A shell script for use under daemontools/runit-style init systems
* A kubernetes daemon set for deployment into a kubernetes cluster

Additional contributions in this area are welcome. Please review the
scripts before deploying to your environment. Caveat emptor, etc.

CONFIGURE

When run from within GCP, the agent should need no additional
configuration to start providing useful profiles.

* The agent tries to use application default credentials[3] to talk to
  the profiler API.
* If running from a GCE instance, additional information such as
  zone and cpu platform are taken from the metadata server and provided
  as labels to the profiler API.

The default behavior can be overridden by command-line flags. Run
`cloud-profiler-perf-record --help` for a list of available options.

USING A CUSTOM PERF COMMAND

By default, the following perf command is run to obtain a system-wide
profile:

	perf record -F 99 -ag -- sleep '{{ .Duration.Seconds }}'

where '{{ .Duration.Seconds }}' is replaced by a duration provided by
the cloud profiler API. The command acts as a drop-in replacement for
`perf record`, so any additional arguments can be passed to customize
the profile.

	cloud-profiler-perf-record -- -F 99 -ag -- sleep '{{ .Duration.Seconds }}'

The only restrictions on the perf command is that it must write its output
to `perf.data` in the current directory.

[1]: https://cloud.google.com/profiler/
[2]: http://www.brendangregg.com/perf.html
[3]: https://cloud.google.com/docs/authentication/production#finding_credentials_automatically
